# ğŸ… Pomodoro Genie æ•°æ®æŒä¹…åŒ–ç­–ç•¥

## é—®é¢˜åˆ†æ

å½“å‰çš„å®ç°å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ åªä½¿ç”¨ `SharedPreferences` æœ¬åœ°å­˜å‚¨
- âŒ æ²¡æœ‰è°ƒç”¨åç«¯APIè¿›è¡Œæ•°æ®æŒä¹…åŒ–
- âŒ ä¸åŒè®¾å¤‡æ•°æ®ä¸ä¸€è‡´
- âŒ æ— æ³•å®ç°å¤šç«¯åŒæ­¥

## æ•°æ®æŒä¹…åŒ–æ—¶æœº

### 1. ç«‹å³æŒä¹…åŒ–ï¼ˆImmediate Persistenceï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** å…³é”®æ•°æ®æ“ä½œï¼Œéœ€è¦ç«‹å³ä¿å­˜åˆ°åç«¯

#### é¡¹ç›®ï¼ˆProjectï¼‰æ“ä½œ
- âœ… **åˆ›å»ºé¡¹ç›®** - `addProject()` 
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–° state
  - åç«¯ï¼šç«‹å³è°ƒç”¨ `POST /api/projects`
  - å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€

- âœ… **æ›´æ–°é¡¹ç›®** - `updateProject()`
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–° state
  - åç«¯ï¼šç«‹å³è°ƒç”¨ `PUT /api/projects/{id}`
  - å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€

- âœ… **åˆ é™¤é¡¹ç›®** - `deleteProject()`
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–° state
  - åç«¯ï¼šç«‹å³è°ƒç”¨ `DELETE /api/projects/{id}`
  - å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€

#### ä»»åŠ¡ï¼ˆTaskï¼‰æ“ä½œ
- âœ… **åˆ›å»ºä»»åŠ¡** - `addTask()`
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–° state
  - åç«¯ï¼šç«‹å³è°ƒç”¨ `POST /api/tasks`
  - å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€

- âœ… **æ›´æ–°ä»»åŠ¡** - `updateTask()`
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–° state
  - åç«¯ï¼šç«‹å³è°ƒç”¨ `PUT /api/tasks/{id}`
  - å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€

- âœ… **åˆ é™¤ä»»åŠ¡** - `deleteTask()`
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–° state
  - åç«¯ï¼šç«‹å³è°ƒç”¨ `DELETE /api/tasks/{id}`
  - å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€

- âœ… **å®Œæˆ/å–æ¶ˆä»»åŠ¡** - `toggleTask()`
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–° state
  - åç«¯ï¼šç«‹å³è°ƒç”¨ `PUT /api/tasks/{id}`
  - å¤±è´¥å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå›æ»šæœ¬åœ°çŠ¶æ€

### 2. æ‰¹é‡æŒä¹…åŒ–ï¼ˆBatch Persistenceï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** é¢‘ç¹å˜åŒ–çš„æ•°æ®ï¼Œå¯ä»¥å»¶è¿ŸåŒæ­¥

#### Pomodoroä¼šè¯
- â±ï¸ **å¼€å§‹ä¼šè¯** - ç«‹å³åˆ›å»º
  - æœ¬åœ°ï¼šè®°å½•å¼€å§‹æ—¶é—´
  - åç«¯ï¼šè°ƒç”¨ `POST /api/pomodoro/start`

- â±ï¸ **å®Œæˆä¼šè¯** - ç«‹å³æ›´æ–°
  - æœ¬åœ°ï¼šè®°å½•ç»“æŸæ—¶é—´å’Œç»Ÿè®¡
  - åç«¯ï¼šè°ƒç”¨ `POST /api/pomodoro/complete`
  - åŒæ—¶æ›´æ–°ä»»åŠ¡çš„ç•ªèŒ„é’Ÿè®¡æ•°

- â¸ï¸ **æš‚åœ/æ¢å¤** - å¯ä»¥å»¶è¿Ÿ
  - æœ¬åœ°ï¼šç«‹å³æ›´æ–°çŠ¶æ€
  - åç«¯ï¼šåœ¨ä¼šè¯å®Œæˆæ—¶ä¸€æ¬¡æ€§ä¸Šä¼ 

### 3. å®šæ—¶åŒæ­¥ï¼ˆPeriodic Syncï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** æ•°æ®åŒæ­¥å’Œå†²çªè§£å†³

- ğŸ”„ **å¯åŠ¨æ—¶åŒæ­¥**
  - ä»åç«¯æ‹‰å–æœ€æ–°æ•°æ®
  - åˆå¹¶æœ¬åœ°å¾…åŒæ­¥çš„æ•°æ®
  - è§£å†³å†²çªï¼ˆä½¿ç”¨æ—¶é—´æˆ³ç­–ç•¥ï¼‰

- ğŸ”„ **åå°å®šæ—¶åŒæ­¥**
  - æ¯5åˆ†é’Ÿæ£€æŸ¥å¾…åŒæ­¥æ•°æ®
  - æ‰¹é‡ä¸Šä¼ æœ¬åœ°æ›´æ”¹
  - ä¸‹è½½æœåŠ¡å™¨æ›´æ–°

- ğŸ”„ **ç½‘ç»œæ¢å¤æ—¶åŒæ­¥**
  - ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
  - ç½‘ç»œæ¢å¤åç«‹å³åŒæ­¥

## å®ç°ç­–ç•¥

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI Layer      â”‚
â”‚  (Widgets)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State Layer     â”‚
â”‚ (Providers)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service Layer   â”‚â”€â”€â”€â”€â–¶â”‚ API Service  â”‚
â”‚ (DataService)   â”‚     â”‚ (Backend)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Layer     â”‚
â”‚(SharedPreferences)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ç»„ä»¶

#### 1. API Service
```dart
class ApiService {
  final String baseUrl;
  final http.Client client;
  
  // Projects
  Future<Project> createProject(Project project);
  Future<Project> updateProject(String id, Project project);
  Future<void> deleteProject(String id);
  Future<List<Project>> getProjects();
  
  // Tasks
  Future<Task> createTask(Task task);
  Future<Task> updateTask(String id, Task task);
  Future<void> deleteTask(String id);
  Future<List<Task>> getTasks({String? projectId});
  
  // Pomodoro
  Future<PomodoroSession> startSession(String taskId);
  Future<PomodoroSession> completeSession(String sessionId, int duration);
}
```

#### 2. Sync Service
```dart
class SyncService {
  // åŒæ­¥çŠ¶æ€
  Future<void> syncAll();
  Future<void> syncProjects();
  Future<void> syncTasks();
  
  // å†²çªè§£å†³
  Future<void> resolveConflicts();
  
  // ç¦»çº¿é˜Ÿåˆ—
  Future<void> addToSyncQueue(SyncOperation operation);
  Future<void> processSyncQueue();
}
```

#### 3. Offline Queue
```dart
class SyncQueue {
  // å¾…åŒæ­¥æ“ä½œé˜Ÿåˆ—
  List<SyncOperation> _queue = [];
  
  void add(SyncOperation op);
  Future<void> process();
  void clear();
}

class SyncOperation {
  final String type; // 'create', 'update', 'delete'
  final String entity; // 'project', 'task', 'session'
  final String id;
  final Map<String, dynamic> data;
  final DateTime timestamp;
}
```

## æ•°æ®æµç¤ºä¾‹

### åˆ›å»ºä»»åŠ¡çš„å®Œæ•´æµç¨‹

```dart
Future<void> addTask(...) async {
  try {
    // 1. ç”Ÿæˆä¸´æ—¶IDï¼ˆå®¢æˆ·ç«¯IDï¼‰
    final tempId = 'temp_${DateTime.now().millisecondsSinceEpoch}';
    
    // 2. ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆä¹è§‚æ›´æ–°ï¼‰
    final task = Task(id: tempId, ...);
    state = [...state, task];
    
    // 3. ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
    await DataService.saveTasks(state);
    
    // 4. è°ƒç”¨åç«¯API
    final savedTask = await ApiService.createTask(task);
    
    // 5. ç”¨åç«¯è¿”å›çš„çœŸå®IDæ›´æ–°æœ¬åœ°
    state = state.map((t) => t.id == tempId ? savedTask : t).toList();
    await DataService.saveTasks(state);
    
  } catch (e) {
    // 6. å¤±è´¥å¤„ç†
    if (isNetworkError(e)) {
      // ç½‘ç»œé”™è¯¯ï¼šåŠ å…¥åŒæ­¥é˜Ÿåˆ—
      await SyncQueue.add(SyncOperation(
        type: 'create',
        entity: 'task',
        data: task.toJson(),
      ));
    } else {
      // å…¶ä»–é”™è¯¯ï¼šå›æ»šå¹¶é€šçŸ¥ç”¨æˆ·
      state = state.where((t) => t.id != tempId).toList();
      showError('åˆ›å»ºä»»åŠ¡å¤±è´¥');
    }
  }
}
```

## é”™è¯¯å¤„ç†ç­–ç•¥

### 1. ç½‘ç»œé”™è¯¯
- âœ… æ“ä½œåŠ å…¥ç¦»çº¿é˜Ÿåˆ—
- âœ… æœ¬åœ°çŠ¶æ€ä¿æŒ
- âœ… æ˜¾ç¤º"ç¦»çº¿æ¨¡å¼"æç¤º
- âœ… ç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥

### 2. æœåŠ¡å™¨é”™è¯¯
- âŒ å›æ»šæœ¬åœ°çŠ¶æ€
- âŒ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- âŒ å…è®¸ç”¨æˆ·é‡è¯•

### 3. å†²çªé”™è¯¯
- ğŸ”„ ä¸‹è½½æœ€æ–°æœåŠ¡å™¨æ•°æ®
- ğŸ”„ åº”ç”¨å†²çªè§£å†³ç­–ç•¥
- ğŸ”„ é‡æ–°æäº¤æœ¬åœ°æ›´æ”¹

## å†²çªè§£å†³ç­–ç•¥

### ç­–ç•¥1ï¼šLast Write Winsï¼ˆæœ€åå†™å…¥è·èƒœï¼‰
- æ¯”è¾ƒ `updated_at` æ—¶é—´æˆ³
- ä¿ç•™æœ€æ–°çš„ç‰ˆæœ¬
- ç®€å•ä½†å¯èƒ½ä¸¢å¤±æ•°æ®

### ç­–ç•¥2ï¼šThree-Way Mergeï¼ˆä¸‰æ–¹åˆå¹¶ï¼‰
- æ¯”è¾ƒæœåŠ¡å™¨ç‰ˆæœ¬ã€æœ¬åœ°ç‰ˆæœ¬ã€åŸºç¡€ç‰ˆæœ¬
- åˆå¹¶éå†²çªå­—æ®µ
- å†²çªå­—æ®µæç¤ºç”¨æˆ·é€‰æ‹©

### æ¨èç­–ç•¥
- **é¡¹ç›®/ä»»åŠ¡å…ƒæ•°æ®**ï¼šLast Write Wins
- **ä»»åŠ¡å®ŒæˆçŠ¶æ€**ï¼šä¼˜å…ˆæœåŠ¡å™¨ç‰ˆæœ¬
- **ç•ªèŒ„é’Ÿè®¡æ•°**ï¼šæ±‚å’Œåˆå¹¶

## æ€§èƒ½ä¼˜åŒ–

### 1. è¯·æ±‚åˆå¹¶
```dart
// æ‰¹é‡æ›´æ–°å¤šä¸ªä»»åŠ¡
Future<void> batchUpdateTasks(List<Task> tasks) async {
  await ApiService.batchUpdate('/api/tasks/batch', tasks);
}
```

### 2. å¢é‡åŒæ­¥
```dart
// åªåŒæ­¥è‡ªä¸Šæ¬¡åŒæ­¥åçš„æ›´æ”¹
Future<void> incrementalSync(DateTime lastSync) async {
  final changes = await ApiService.getChanges(since: lastSync);
  await applyChanges(changes);
}
```

### 3. æ•°æ®å‹ç¼©
```dart
// ä½¿ç”¨ gzip å‹ç¼©å¤§é‡æ•°æ®ä¼ è¾“
final compressed = gzip.encode(json.encode(data));
```

## å®ç°ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€åŒæ­¥ â­â­â­
1. âœ… åˆ›å»º ApiService
2. âœ… é¡¹ç›®çš„ CRUD è°ƒç”¨åç«¯
3. âœ… ä»»åŠ¡çš„ CRUD è°ƒç”¨åç«¯
4. âœ… åŸºç¡€é”™è¯¯å¤„ç†

### Phase 2: ç¦»çº¿æ”¯æŒ â­â­
1. âœ… å®ç° SyncQueue
2. âœ… ç½‘ç»œçŠ¶æ€ç›‘å¬
3. âœ… ç¦»çº¿æ“ä½œé˜Ÿåˆ—
4. âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶

### Phase 3: é«˜çº§åŠŸèƒ½ â­
1. âœ… å†²çªæ£€æµ‹å’Œè§£å†³
2. âœ… å¢é‡åŒæ­¥
3. âœ… æ‰¹é‡æ“ä½œä¼˜åŒ–
4. âœ… æ•°æ®é¢„åŠ è½½

## æµ‹è¯•è¦ç‚¹

### å•å…ƒæµ‹è¯•
- âœ… APIè°ƒç”¨æˆåŠŸ
- âœ… APIè°ƒç”¨å¤±è´¥
- âœ… ç¦»çº¿é˜Ÿåˆ—é€»è¾‘
- âœ… å†²çªè§£å†³é€»è¾‘

### é›†æˆæµ‹è¯•
- âœ… åˆ›å»º-è¯»å–-æ›´æ–°-åˆ é™¤æµç¨‹
- âœ… ç¦»çº¿æ¨¡å¼åˆ‡æ¢
- âœ… ç½‘ç»œæ¢å¤ååŒæ­¥
- âœ… å¤šè®¾å¤‡å¹¶å‘æ“ä½œ

### åœºæ™¯æµ‹è¯•
- âœ… é£è¡Œæ¨¡å¼ä¸‹æ“ä½œ
- âœ… ç½‘ç»œåˆ‡æ¢ï¼ˆWiFi â†” èœ‚çªï¼‰
- âœ… æ…¢é€Ÿç½‘ç»œ
- âœ… æœåŠ¡å™¨ç»´æŠ¤

## ç›‘æ§æŒ‡æ ‡

- ğŸ“Š åŒæ­¥æˆåŠŸç‡
- ğŸ“Š åŒæ­¥å»¶è¿Ÿ
- ğŸ“Š å†²çªå‘ç”Ÿç‡
- ğŸ“Š ç¦»çº¿é˜Ÿåˆ—å¤§å°
- ğŸ“Š APIå“åº”æ—¶é—´

## æ€»ç»“

**å…³é”®åŸåˆ™ï¼š**
1. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ** - ä¹è§‚æ›´æ–°ï¼Œç«‹å³å“åº”
2. **æ•°æ®ä¸€è‡´æ€§** - æœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹
3. **å®¹é”™æ€§** - ç¦»çº¿å¯ç”¨ï¼Œè‡ªåŠ¨æ¢å¤
4. **æ€§èƒ½** - æ‰¹é‡æ“ä½œï¼Œå¢é‡åŒæ­¥

**å®ç°å»ºè®®ï¼š**
- å…ˆå®ç°åŸºç¡€çš„ç«‹å³æŒä¹…åŒ–ï¼ˆPhase 1ï¼‰
- å†æ·»åŠ ç¦»çº¿æ”¯æŒï¼ˆPhase 2ï¼‰
- æœ€åä¼˜åŒ–é«˜çº§åŠŸèƒ½ï¼ˆPhase 3ï¼‰

