name: ðŸš€ Simple Flutter Web Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-web:
    name: ðŸŒ Build Flutter Web
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ” Analyze code
      run: |
        cd mobile
        flutter analyze --fatal-infos
        
    - name: ðŸ”¨ Build Flutter Web
      run: |
        cd mobile
        flutter build web --release --web-renderer html --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Create deployment package
      run: |
        mkdir -p dist/web
        cp -r mobile/build/web/* dist/web/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > dist/web/deploy.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ Deploying PomodoroGenie Web App..."
        echo "ðŸ“ Copying files to /Applications/PomodoroGenie/"
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        sudo mkdir -p /Applications/PomodoroGenie
        sudo cp -r * /Applications/PomodoroGenie/
        sudo chown -R $(whoami):staff /Applications/PomodoroGenie
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > /Applications/PomodoroGenie/start.sh << 'EOF2'
        #!/bin/bash
        cd /Applications/PomodoroGenie
        python3 -m http.server 3001 --bind 0.0.0.0
        EOF2
        chmod +x /Applications/PomodoroGenie/start.sh
        
        # åˆ›å»ºåœæ­¢è„šæœ¬
        cat > /Applications/PomodoroGenie/stop.sh << 'EOF2'
        #!/bin/bash
        pkill -f "python3 -m http.server 3001"
        EOF2
        chmod +x /Applications/PomodoroGenie/stop.sh
        
        echo "âœ… Deployment complete!"
        echo "ðŸš€ Start: /Applications/PomodoroGenie/start.sh"
        echo "ðŸ›‘ Stop: /Applications/PomodoroGenie/stop.sh"
        echo "ðŸŒ Access: http://localhost:3001"
        EOF
        chmod +x dist/web/deploy.sh
        
        # åˆ›å»ºREADME
        cat > dist/web/README.md << 'EOF'
        # PomodoroGenie Web App
        
        ## ðŸš€ Quick Start
        
        1. **Deploy**:
           ```bash
           ./deploy.sh
           ```
        
        2. **Start**:
           ```bash
           /Applications/PomodoroGenie/start.sh
           ```
        
        3. **Access**:
           - Local: http://localhost:3001
           - Network: http://[your-ip]:3001
        
        ## ðŸ“‹ Features
        
        - âœ… Pomodoro Timer
        - âœ… Task Management
        - âœ… Statistics Dashboard
        - âœ… White Noise
        - âœ… Focus Mode
        - âœ… Cross-platform Support
        
        ## ðŸ”§ System Requirements
        
        - Modern web browser
        - Python 3.7+ (for local server)
        - 2GB free disk space
        
        ## ðŸ“ž Support
        
        - GitHub Issues: https://github.com/your-username/pomodoro-genie/issues
        - Documentation: https://github.com/your-username/pomodoro-genie/wiki
        EOF
        
    - name: ðŸ“¤ Upload Web artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-app-${{ github.sha }}
        path: dist/web/
        retention-days: 30
        
    - name: ðŸ“Š Build Summary
      run: |
        echo "## ðŸŒ Flutter Web Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Build Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Web App**: Built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Script**: Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Available Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **Web App**: Flutter Web application" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy Script**: Automated deployment script" >> $GITHUB_STEP_SUMMARY
        echo "- **README**: Installation and usage guide" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download artifacts from Actions tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract the web-app archive" >> $GITHUB_STEP_SUMMARY
        echo "3. Run \`./deploy.sh\` to deploy" >> $GITHUB_STEP_SUMMARY
        echo "4. Start the server and access at http://localhost:3001" >> $GITHUB_STEP_SUMMARY
