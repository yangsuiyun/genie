name: ðŸš€ Automated Release Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes'
        required: false
        type: string
        default: 'Bug fixes and improvements'

env:
  FLUTTER_VERSION: '3.24.0'
  APP_NAME: 'PomodoroGenie'

jobs:
  # ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ubuntu-latest
    outputs:
      quality-passed: ${{ steps.quality-check.outputs.passed }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ” Code Analysis
      run: |
        cd mobile
        flutter analyze --fatal-infos
        
    - name: ðŸ§ª Run Tests
      run: |
        cd mobile
        flutter test --coverage
        
    - name: ðŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: mobile/coverage/lcov.info
        flags: flutter
        name: flutter-coverage
        
    - name: âœ… Quality Check Passed
      id: quality-check
      run: echo "passed=true" >> $GITHUB_OUTPUT

  # ðŸŒ æž„å»ºWebåº”ç”¨
  build-web:
    name: ðŸŒ Build Web App
    runs-on: ubuntu-latest
    needs: quality-gate
    if: ${{ needs.quality-gate.outputs.quality-passed == 'true' }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”¨ Build Flutter Web
      run: |
        cd mobile
        flutter build web --release --web-renderer html --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Create Web Package
      run: |
        mkdir -p release/web
        cp -r mobile/build/web/* release/web/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > release/web/deploy.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ Deploying PomodoroGenie Web App..."
        echo "ðŸ“ Copying files to /Applications/PomodoroGenie/"
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        sudo mkdir -p /Applications/PomodoroGenie
        sudo cp -r * /Applications/PomodoroGenie/
        sudo chown -R $(whoami):staff /Applications/PomodoroGenie
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > /Applications/PomodoroGenie/start.sh << 'EOF2'
        #!/bin/bash
        cd /Applications/PomodoroGenie
        python3 -m http.server 3001 --bind 0.0.0.0
        EOF2
        chmod +x /Applications/PomodoroGenie/start.sh
        
        # åˆ›å»ºåœæ­¢è„šæœ¬
        cat > /Applications/PomodoroGenie/stop.sh << 'EOF2'
        #!/bin/bash
        pkill -f "python3 -m http.server 3001"
        EOF2
        chmod +x /Applications/PomodoroGenie/stop.sh
        
        echo "âœ… Deployment complete!"
        echo "ðŸš€ Start: /Applications/PomodoroGenie/start.sh"
        echo "ðŸ›‘ Stop: /Applications/PomodoroGenie/stop.sh"
        echo "ðŸŒ Access: http://localhost:3001"
        EOF
        chmod +x release/web/deploy.sh
        
        # åˆ›å»ºREADME
        cat > release/web/README.md << 'EOF'
        # PomodoroGenie Web App
        
        ## ðŸš€ Quick Start
        
        1. **Deploy**:
           ```bash
           ./deploy.sh
           ```
        
        2. **Start**:
           ```bash
           /Applications/PomodoroGenie/start.sh
           ```
        
        3. **Access**:
           - Local: http://localhost:3001
           - Network: http://[your-ip]:3001
        
        ## ðŸ“‹ Features
        
        - âœ… Pomodoro Timer
        - âœ… Task Management
        - âœ… Statistics Dashboard
        - âœ… White Noise
        - âœ… Focus Mode
        - âœ… Cross-platform Support
        
        ## ðŸ”§ System Requirements
        
        - Modern web browser
        - Python 3.7+ (for local server)
        - 2GB free disk space
        
        ## ðŸ“ž Support
        
        - GitHub Issues: https://github.com/your-username/pomodoro-genie/issues
        - Documentation: https://github.com/your-username/pomodoro-genie/wiki
        EOF
        
    - name: ðŸ“¤ Upload Web Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-app-${{ github.ref_name }}
        path: release/web/
        retention-days: 90

  # ðŸŽ æž„å»ºmacOSåº”ç”¨
  build-macos:
    name: ðŸŽ Build macOS App
    runs-on: macos-latest
    needs: quality-gate
    if: ${{ needs.quality-gate.outputs.quality-passed == 'true' }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”§ Enable macOS desktop
      run: |
        cd mobile
        flutter config --enable-macos-desktop
        
    - name: ðŸ”¨ Build macOS App
      run: |
        cd mobile
        flutter build macos --release --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Create macOS Package
      run: |
        mkdir -p release/macos
        APP_PATH="mobile/build/macos/Build/Products/Release/${APP_NAME}.app"
        
        if [ -d "$APP_PATH" ]; then
          cp -r "$APP_PATH" release/macos/
          
          # åˆ›å»ºDMG
          hdiutil create -volname "${APP_NAME}" \
            -srcfolder release/macos \
            -ov -format UDZO \
            release/macos/${APP_NAME}-${{ github.ref_name }}.dmg
            
          # åˆ›å»ºPKGå®‰è£…åŒ…
          pkgbuild --root release/macos \
            --identifier com.pomodorogenie.app \
            --version ${{ github.ref_name }} \
            --install-location "/Applications" \
            release/macos/${APP_NAME}-${{ github.ref_name }}.pkg
            
          # åˆ›å»ºå®‰è£…è¯´æ˜Ž
          cat > release/macos/INSTALL.md << 'EOF'
          # PomodoroGenie macOS App Installation
          
          ## ðŸ“¦ Installation Options
          
          ### Option 1: DMG Installation (Recommended)
          1. Double-click `PomodoroGenie-${{ github.ref_name }}.dmg`
          2. Drag `PomodoroGenie.app` to Applications folder
          3. Eject the DMG
          4. Launch from Applications folder
          
          ### Option 2: PKG Installation
          1. Double-click `PomodoroGenie-${{ github.ref_name }}.pkg`
          2. Follow the installation wizard
          3. Launch from Applications folder
          
          ### Option 3: Direct Installation
          1. Copy `PomodoroGenie.app` to `/Applications/`
          2. Double-click to run
          
          ## ðŸ”’ Security Note
          
          If macOS shows a security warning:
          1. Go to System Preferences > Security & Privacy
          2. Click "Open Anyway" for PomodoroGenie
          
          ## ðŸ“‹ System Requirements
          
          - macOS 10.15 (Catalina) or later
          - Intel or Apple Silicon processor
          - 4GB RAM minimum
          - 2GB free disk space
          
          ## ðŸš€ First Launch
          
          The app will start automatically after installation.
          Access it from Applications folder or Launchpad.
          
          ## ðŸ“ž Support
          
          - GitHub Issues: https://github.com/your-username/pomodoro-genie/issues
          - Documentation: https://github.com/your-username/pomodoro-genie/wiki
          EOF
          
        else
          echo "âŒ macOS app build failed"
          exit 1
        fi
        
    - name: ðŸ“¤ Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-app-${{ github.ref_name }}
        path: release/macos/
        retention-days: 90

  # ðŸš€ åˆ›å»ºGitHub Release
  create-release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [build-web, build-macos]
    if: ${{ needs.build-web.result == 'success' && needs.build-macos.result == 'success' }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download Web artifacts
      uses: actions/download-artifact@v4
      with:
        name: web-app-${{ github.ref_name }}
        path: release/web/
        
    - name: ðŸ“¥ Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-app-${{ github.ref_name }}
        path: release/macos/
        
    - name: ðŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: PomodoroGenie ${{ github.ref_name }}
        body: |
          # ðŸŽ PomodoroGenie Release ${{ github.ref_name }}
          
          ## ðŸ“¦ Downloads
          
          ### ðŸŒ Web Application
          - **File**: `web-app-${{ github.ref_name }}.zip`
          - **Type**: Flutter Web App
          - **Platform**: Cross-platform (Browser)
          - **Size**: ~$(du -sh release/web/ | cut -f1)
          
          ### ðŸŽ macOS Application
          - **File**: `macos-app-${{ github.ref_name }}.zip`
          - **Type**: Native macOS App
          - **Platform**: macOS 10.15+
          - **Size**: ~$(du -sh release/macos/ | cut -f1)
          
          ## ðŸš€ Quick Start
          
          ### Web App
          1. Extract the web-app archive
          2. Run `./deploy.sh`
          3. Access at http://localhost:3001
          
          ### macOS App
          1. Extract the macos-app archive
          2. Follow `INSTALL.md` instructions
          3. Launch from Applications folder
          
          ## ðŸ“‹ Features
          
          - âœ… Pomodoro Timer with customizable durations
          - âœ… Task Management with priority levels
          - âœ… Statistics Dashboard with charts
          - âœ… White Noise for focus enhancement
          - âœ… Focus Mode with immersive experience
          - âœ… Cross-platform Support (Web + macOS)
          - âœ… Responsive Design for all screen sizes
          - âœ… Local Data Storage
          - âœ… Export/Import functionality
          
          ## ðŸ”§ System Requirements
          
          ### Web App
          - Modern web browser (Chrome, Firefox, Safari, Edge)
          - Python 3.7+ (for local server)
          - 2GB free disk space
          
          ### macOS App
          - macOS 10.15 (Catalina) or later
          - Intel or Apple Silicon processor
          - 4GB RAM minimum
          - 2GB free disk space
          
          ## ðŸ› Bug Fixes
          
          ${{ github.event.inputs.release_notes || 'Bug fixes and improvements' }}
          
          ## ðŸ“ž Support
          
          - **GitHub Issues**: [Create an issue](https://github.com/your-username/pomodoro-genie/issues)
          - **Documentation**: [View wiki](https://github.com/your-username/pomodoro-genie/wiki)
          - **Community**: [Join discussions](https://github.com/your-username/pomodoro-genie/discussions)
          
          ## ðŸ”„ Update Instructions
          
          ### Web App
          1. Stop the current server
          2. Extract new files
          3. Run `./deploy.sh`
          4. Start the server
          
          ### macOS App
          1. Quit the current app
          2. Install new version
          3. Launch updated app
          
          ---
          
          **Full Changelog**: https://github.com/your-username/pomodoro-genie/compare/${{ github.event.before }}...${{ github.ref_name }}
        files: |
          release/web/web-app-${{ github.ref_name }}.zip
          release/macos/macos-app-${{ github.ref_name }}.zip
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}

  # ðŸ“Š å‘å¸ƒåŽé€šçŸ¥
  notify-release:
    name: ðŸ“Š Release Notification
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    steps:
    - name: ðŸ“Š Generate Release Summary
      run: |
        echo "## ðŸš€ Release ${{ github.ref_name }} Published!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Release Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“‹ Build Results" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.create-release.result }}" = "success" ]; then
          echo "âœ… **Release Created**: Successfully published to GitHub" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Web App**: Available for download" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **macOS App**: Available for download" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Release Failed**: Check build logs for details" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Page**: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Download**: https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Issues**: https://github.com/${{ github.repository }}/issues" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Test the release on target platforms" >> $GITHUB_STEP_SUMMARY
        echo "2. Update documentation if needed" >> $GITHUB_STEP_SUMMARY
        echo "3. Announce the release to users" >> $GITHUB_STEP_SUMMARY
        echo "4. Monitor for any issues" >> $GITHUB_STEP_SUMMARY
