name: ðŸš€ Multi-Platform Build Matrix

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Target platforms'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - web
        - macos
        - windows
        - linux
      build_mode:
        description: 'Build mode'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug
        - profile

env:
  FLUTTER_VERSION: '3.24.0'
  APP_NAME: 'PomodoroGenie'
  APP_VERSION: '1.0.0'

jobs:
  # ðŸŒ Webå¹³å°æž„å»º
  build-web:
    name: ðŸŒ Web Build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'web' || github.event.inputs.platforms == '' }}
    strategy:
      matrix:
        web-renderer: [html, canvaskit]
        include:
          - web-renderer: html
            renderer-name: HTML
          - web-renderer: canvaskit
            renderer-name: CanvasKit
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”¨ Build Flutter Web (${{ matrix.renderer-name }})
      run: |
        cd mobile
        flutter build web \
          --${{ github.event.inputs.build_mode || 'release' }} \
          --web-renderer ${{ matrix.web-renderer }} \
          --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Package Web App
      run: |
        mkdir -p dist/web-${{ matrix.web-renderer }}
        cp -r mobile/build/web/* dist/web-${{ matrix.web-renderer }}/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > dist/web-${{ matrix.web-renderer }}/deploy.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ Deploying PomodoroGenie Web App (${{ matrix.renderer-name }})..."
        sudo mkdir -p /Applications/PomodoroGenie-${{ matrix.web-renderer }}
        sudo cp -r * /Applications/PomodoroGenie-${{ matrix.web-renderer }}/
        sudo chown -R $(whoami):staff /Applications/PomodoroGenie-${{ matrix.web-renderer }}
        echo "âœ… Deployment complete!"
        echo "ðŸŒ Access: http://localhost:3001"
        EOF
        chmod +x dist/web-${{ matrix.web-renderer }}/deploy.sh
        
    - name: ðŸ“¤ Upload Web Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-${{ matrix.web-renderer }}-${{ github.sha }}
        path: dist/web-${{ matrix.web-renderer }}/
        retention-days: 30

  # ðŸŽ macOSå¹³å°æž„å»º
  build-macos:
    name: ðŸŽ macOS Build
    runs-on: macos-latest
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' || github.event.inputs.platforms == '' }}
    strategy:
      matrix:
        architecture: [x64, arm64]
        include:
          - architecture: x64
            arch-name: Intel
          - architecture: arm64
            arch-name: Apple Silicon
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”§ Enable macOS desktop
      run: |
        cd mobile
        flutter config --enable-macos-desktop
        
    - name: ðŸ”¨ Build macOS App (${{ matrix.arch-name }})
      run: |
        cd mobile
        flutter build macos \
          --${{ github.event.inputs.build_mode || 'release' }} \
          --target-platform darwin-${{ matrix.architecture }} \
          --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Package macOS App
      run: |
        mkdir -p dist/macos-${{ matrix.architecture }}
        APP_PATH="mobile/build/macos/Build/Products/${{ github.event.inputs.build_mode || 'Release' }}/${APP_NAME}.app"
        
        if [ -d "$APP_PATH" ]; then
          cp -r "$APP_PATH" dist/macos-${{ matrix.architecture }}/
          
          # åˆ›å»ºDMG
          hdiutil create -volname "${APP_NAME}-${{ matrix.arch-name }}" \
            -srcfolder dist/macos-${{ matrix.architecture }} \
            -ov -format UDZO \
            dist/macos-${{ matrix.architecture }}/${APP_NAME}-${{ matrix.arch-name }}-${APP_VERSION}.dmg
            
          # åˆ›å»ºå®‰è£…è¯´æ˜Ž
          cat > dist/macos-${{ matrix.architecture }}/README.md << EOF
          # PomodoroGenie macOS App (${{ matrix.arch-name }})
          
          ## ðŸ“¦ Installation
          
          1. **DMG Installation**:
             - Double-click \`${APP_NAME}-${{ matrix.arch-name }}-${APP_VERSION}.dmg\`
             - Drag \`${APP_NAME}.app\` to Applications folder
          
          2. **Direct Installation**:
             - Copy \`${APP_NAME}.app\` to \`/Applications/\`
             - Double-click to run
          
          ## ðŸ”’ Security
          
          If macOS shows security warnings:
          1. Go to System Preferences > Security & Privacy
          2. Click "Open Anyway" for PomodoroGenie
          
          ## ðŸ“‹ System Requirements
          
          - macOS 10.15 (Catalina) or later
          - ${{ matrix.arch-name }} processor
          - 4GB RAM minimum
          - 2GB free disk space
          EOF
          
        else
          echo "âŒ macOS app build failed for ${{ matrix.architecture }}"
          exit 1
        fi
        
    - name: ðŸ“¤ Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-${{ matrix.architecture }}-${{ github.sha }}
        path: dist/macos-${{ matrix.architecture }}/
        retention-days: 30

  # ðŸªŸ Windowså¹³å°æž„å»º
  build-windows:
    name: ðŸªŸ Windows Build
    runs-on: windows-latest
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' || github.event.inputs.platforms == '' }}
    strategy:
      matrix:
        architecture: [x64, x86]
        include:
          - architecture: x64
            arch-name: 64-bit
          - architecture: x86
            arch-name: 32-bit
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”§ Enable Windows desktop
      run: |
        cd mobile
        flutter config --enable-windows-desktop
        
    - name: ðŸ”¨ Build Windows App (${{ matrix.arch-name }})
      run: |
        cd mobile
        flutter build windows \
          --${{ github.event.inputs.build_mode || 'release' }} \
          --target-platform windows-${{ matrix.architecture }} \
          --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Package Windows App
      run: |
        mkdir dist\windows-${{ matrix.architecture }}
        xcopy "mobile\build\windows\${{ github.event.inputs.build_mode || 'Release' }}\runner\*" "dist\windows-${{ matrix.architecture }}\" /E /I
        
        # åˆ›å»ºå®‰è£…è¯´æ˜Ž
        echo # PomodoroGenie Windows App (${{ matrix.arch-name }}) > dist\windows-${{ matrix.architecture }}\README.md
        echo. >> dist\windows-${{ matrix.architecture }}\README.md
        echo ## ðŸ“¦ Installation >> dist\windows-${{ matrix.architecture }}\README.md
        echo. >> dist\windows-${{ matrix.architecture }}\README.md
        echo 1. Extract all files to a folder >> dist\windows-${{ matrix.architecture }}\README.md
        echo 2. Run \`PomodoroGenie.exe\` >> dist\windows-${{ matrix.architecture }}\README.md
        echo. >> dist\windows-${{ matrix.architecture }}\README.md
        echo ## ðŸ“‹ System Requirements >> dist\windows-${{ matrix.architecture }}\README.md
        echo. >> dist\windows-${{ matrix.architecture }}\README.md
        echo - Windows 10 or later >> dist\windows-${{ matrix.architecture }}\README.md
        echo - ${{ matrix.arch-name }} processor >> dist\windows-${{ matrix.architecture }}\README.md
        echo - 4GB RAM minimum >> dist\windows-${{ matrix.architecture }}\README.md
        echo - 2GB free disk space >> dist\windows-${{ matrix.architecture }}\README.md
        
    - name: ðŸ“¤ Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-${{ matrix.architecture }}-${{ github.sha }}
        path: dist/windows-${{ matrix.architecture }}/
        retention-days: 30

  # ðŸ§ Linuxå¹³å°æž„å»º
  build-linux:
    name: ðŸ§ Linux Build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' || github.event.inputs.platforms == '' }}
    strategy:
      matrix:
        architecture: [x64, arm64]
        include:
          - architecture: x64
            arch-name: x86_64
          - architecture: arm64
            arch-name: ARM64
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”§ Enable Linux desktop
      run: |
        cd mobile
        flutter config --enable-linux-desktop
        
    - name: ðŸ”¨ Build Linux App (${{ matrix.arch-name }})
      run: |
        cd mobile
        flutter build linux \
          --${{ github.event.inputs.build_mode || 'release' }} \
          --target-platform linux-${{ matrix.architecture }} \
          --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Package Linux App
      run: |
        mkdir -p dist/linux-${{ matrix.architecture }}
        cp -r mobile/build/linux/${{ github.event.inputs.build_mode || 'release' }}/bundle/* dist/linux-${{ matrix.architecture }}/
        
        # åˆ›å»ºå®‰è£…è„šæœ¬
        cat > dist/linux-${{ matrix.architecture }}/install.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ Installing PomodoroGenie Linux App..."
        
        # åˆ›å»ºåº”ç”¨ç›®å½•
        sudo mkdir -p /opt/pomodoro-genie
        sudo cp -r * /opt/pomodoro-genie/
        
        # åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
        cat > ~/.local/share/applications/pomodoro-genie.desktop << 'EOF2'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=PomodoroGenie
        Comment=Focus and productivity management tool
        Exec=/opt/pomodoro-genie/pomodoro_genie
        Icon=/opt/pomodoro-genie/data/flutter_assets/assets/icons/app_icon.png
        Terminal=false
        Categories=Productivity;
        EOF2
        
        chmod +x ~/.local/share/applications/pomodoro-genie.desktop
        
        echo "âœ… Installation complete!"
        echo "ðŸš€ Launch from Applications menu or run: /opt/pomodoro-genie/pomodoro_genie"
        EOF
        chmod +x dist/linux-${{ matrix.architecture }}/install.sh
        
        # åˆ›å»ºREADME
        cat > dist/linux-${{ matrix.architecture }}/README.md << EOF
        # PomodoroGenie Linux App (${{ matrix.arch-name }})
        
        ## ðŸ“¦ Installation
        
        1. **Automatic Installation**:
           \`\`\`bash
           ./install.sh
           \`\`\`
        
        2. **Manual Installation**:
           - Copy files to \`/opt/pomodoro-genie/\`
           - Run \`./pomodoro_genie\`
        
        ## ðŸ“‹ System Requirements
        
        - Ubuntu 18.04+ or compatible Linux distribution
        - ${{ matrix.arch-name }} processor
        - 4GB RAM minimum
        - 2GB free disk space
        - GTK 3.0+ (for GUI)
        EOF
        
    - name: ðŸ“¤ Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-${{ matrix.architecture }}-${{ github.sha }}
        path: dist/linux-${{ matrix.architecture }}/
        retention-days: 30

  # ðŸ“Š æž„å»ºæ±‡æ€»æŠ¥å‘Š
  build-summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [build-web, build-macos, build-windows, build-linux]
    if: always()
    steps:
    - name: ðŸ“Š Generate Build Summary
      run: |
        echo "## ðŸš€ Multi-Platform Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Mode**: ${{ github.event.inputs.build_mode || 'release' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Platforms**: ${{ github.event.inputs.platforms || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŽ¯ Build Results" >> $GITHUB_STEP_SUMMARY
        
        # Web builds
        if [ "${{ needs.build-web.result }}" = "success" ]; then
          echo "âœ… **Web Platform**: Built successfully (HTML + CanvasKit)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Web Platform**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # macOS builds
        if [ "${{ needs.build-macos.result }}" = "success" ]; then
          echo "âœ… **macOS Platform**: Built successfully (Intel + Apple Silicon)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **macOS Platform**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Windows builds
        if [ "${{ needs.build-windows.result }}" = "success" ]; then
          echo "âœ… **Windows Platform**: Built successfully (32-bit + 64-bit)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Windows Platform**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Linux builds
        if [ "${{ needs.build-linux.result }}" = "success" ]; then
          echo "âœ… **Linux Platform**: Built successfully (x86_64 + ARM64)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Linux Platform**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Available Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **Web Apps**: HTML and CanvasKit renderers" >> $GITHUB_STEP_SUMMARY
        echo "- **macOS Apps**: Intel and Apple Silicon versions" >> $GITHUB_STEP_SUMMARY
        echo "- **Windows Apps**: 32-bit and 64-bit versions" >> $GITHUB_STEP_SUMMARY
        echo "- **Linux Apps**: x86_64 and ARM64 versions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download artifacts from Actions tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Test each platform build" >> $GITHUB_STEP_SUMMARY
        echo "3. Deploy to target systems" >> $GITHUB_STEP_SUMMARY
        echo "4. Create release if all tests pass" >> $GITHUB_STEP_SUMMARY
