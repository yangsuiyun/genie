name: ðŸŽ Build macOS Production Artifacts

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - web-only
        - macos-only
      release_tag:
        description: 'Release tag (optional)'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.24.0'
  APP_NAME: 'PomodoroGenie'
  APP_VERSION: '1.0.0'
  BUNDLE_ID: 'com.pomodorogenie.app'

jobs:
  # ðŸ” æ£€æŸ¥ä»£ç è´¨é‡
  quality-check:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ” Analyze code
      run: |
        cd mobile
        flutter analyze --fatal-infos
        
    - name: ðŸ§ª Run tests
      run: |
        cd mobile
        flutter test --coverage
        
    - name: ðŸ“Š Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: mobile/coverage/lcov.info
        flags: flutter
        name: flutter-coverage

  # ðŸŒ æž„å»ºFlutter Webåº”ç”¨
  build-web:
    name: ðŸŒ Build Flutter Web
    runs-on: ubuntu-latest
    needs: quality-check
    if: ${{ github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'web-only' || github.event.inputs.build_type == '' }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”¨ Build Flutter Web
      run: |
        cd mobile
        flutter build web --release --web-renderer html --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Create Web deployment package
      run: |
        mkdir -p dist/web
        cp -r mobile/build/web/* dist/web/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > dist/web/deploy.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ Deploying PomodoroGenie Web App..."
        echo "ðŸ“ Copying files to /Applications/PomodoroGenie/"
        sudo mkdir -p /Applications/PomodoroGenie
        sudo cp -r * /Applications/PomodoroGenie/
        sudo chown -R $(whoami):staff /Applications/PomodoroGenie
        echo "âœ… Deployment complete!"
        echo "ðŸŒ Access: http://localhost:3001"
        EOF
        chmod +x dist/web/deploy.sh
        
        # åˆ›å»ºREADME
        cat > dist/web/README.md << 'EOF'
        # PomodoroGenie Web App
        
        ## ðŸš€ Quick Start
        
        1. Run deployment script:
           ```bash
           ./deploy.sh
           ```
        
        2. Start the server:
           ```bash
           cd /Applications/PomodoroGenie
           python3 -m http.server 3001 --bind 0.0.0.0
           ```
        
        3. Access the app:
           - Local: http://localhost:3001
           - Network: http://[your-ip]:3001
        
        ## ðŸ“‹ Features
        
        - âœ… Pomodoro Timer
        - âœ… Task Management
        - âœ… Statistics Dashboard
        - âœ… White Noise
        - âœ… Focus Mode
        EOF
        
    - name: ðŸ“¤ Upload Web artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-app-${{ github.sha }}
        path: dist/web/
        retention-days: 30

  # ðŸŽ æž„å»ºmacOSåŽŸç”Ÿåº”ç”¨
  build-macos:
    name: ðŸŽ Build macOS App
    runs-on: macos-latest
    needs: quality-check
    if: ${{ github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'macos-only' || github.event.inputs.build_type == '' }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        cd mobile
        flutter pub get
        
    - name: ðŸ”§ Enable macOS desktop
      run: |
        cd mobile
        flutter config --enable-macos-desktop
        
    - name: ðŸ”¨ Build macOS app
      run: |
        cd mobile
        flutter build macos --release --dart-define=FLUTTER_WEB_USE_SKIA=false
        
    - name: ðŸ“¦ Create macOS app package
      run: |
        mkdir -p dist/macos
        APP_PATH="mobile/build/macos/Build/Products/Release/${APP_NAME}.app"
        
        if [ -d "$APP_PATH" ]; then
          cp -r "$APP_PATH" dist/macos/
          
          # åˆ›å»ºDMG
          hdiutil create -volname "${APP_NAME}" \
            -srcfolder dist/macos \
            -ov -format UDZO \
            dist/macos/${APP_NAME}-${APP_VERSION}.dmg
            
          # åˆ›å»ºPKGå®‰è£…åŒ…
          pkgbuild --root dist/macos \
            --identifier ${BUNDLE_ID} \
            --version ${APP_VERSION} \
            --install-location "/Applications" \
            dist/macos/${APP_NAME}-${APP_VERSION}.pkg
            
          # åˆ›å»ºå®‰è£…è¯´æ˜Ž
          cat > dist/macos/INSTALL.md << 'EOF'
          # PomodoroGenie macOS App Installation
          
          ## ðŸ“¦ Installation Options
          
          ### Option 1: Direct App Installation
          1. Copy `PomodoroGenie.app` to `/Applications/`
          2. Double-click to run
          
          ### Option 2: DMG Installation
          1. Double-click `PomodoroGenie-1.0.0.dmg`
          2. Drag `PomodoroGenie.app` to Applications folder
          3. Eject the DMG
          
          ### Option 3: PKG Installation
          1. Double-click `PomodoroGenie-1.0.0.pkg`
          2. Follow the installation wizard
          
          ## ðŸ”’ Security Note
          
          If macOS shows a security warning:
          1. Go to System Preferences > Security & Privacy
          2. Click "Open Anyway" for PomodoroGenie
          
          ## ðŸš€ First Launch
          
          The app will start automatically after installation.
          Access it from Applications folder or Launchpad.
          
          ## ðŸ“‹ System Requirements
          
          - macOS 10.15 (Catalina) or later
          - 4GB RAM minimum
          - 2GB free disk space
          EOF
          
        else
          echo "âŒ macOS app build failed"
          exit 1
        fi
        
    - name: ðŸ“¤ Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-app-${{ github.sha }}
        path: dist/macos/
        retention-days: 30

  # ðŸš€ åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
  create-release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [build-web, build-macos]
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '' }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Download Web artifacts
      uses: actions/download-artifact@v4
      with:
        name: web-app-${{ github.sha }}
        path: dist/web/
        
    - name: ðŸ“¥ Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-app-${{ github.sha }}
        path: dist/macos/
        
    - name: ðŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_tag }}
        name: PomodoroGenie ${{ github.event.inputs.release_tag }}
        body: |
          # ðŸŽ PomodoroGenie Release ${{ github.event.inputs.release_tag }}
          
          ## ðŸ“¦ Downloads
          
          ### ðŸŒ Web Application
          - **File**: `web-app-${{ github.sha }}.zip`
          - **Type**: Flutter Web App
          - **Platform**: Cross-platform (Browser)
          
          ### ðŸŽ macOS Application
          - **File**: `macos-app-${{ github.sha }}.zip`
          - **Type**: Native macOS App
          - **Platform**: macOS 10.15+
          
          ## ðŸš€ Quick Start
          
          ### Web App
          1. Extract the web-app archive
          2. Run `./deploy.sh`
          3. Access at http://localhost:3001
          
          ### macOS App
          1. Extract the macos-app archive
          2. Follow `INSTALL.md` instructions
          3. Launch from Applications folder
          
          ## ðŸ“‹ Features
          
          - âœ… Pomodoro Timer
          - âœ… Task Management
          - âœ… Statistics Dashboard
          - âœ… White Noise
          - âœ… Focus Mode
          - âœ… Cross-platform Support
          
          ## ðŸ”§ System Requirements
          
          ### Web App
          - Modern web browser
          - Python 3.7+ (for local server)
          
          ### macOS App
          - macOS 10.15 (Catalina) or later
          - 4GB RAM minimum
          - 2GB free disk space
        files: |
          dist/web/web-app-${{ github.sha }}.zip
          dist/macos/macos-app-${{ github.sha }}.zip
        draft: false
        prerelease: false

  # ðŸ“Š æž„å»ºçŠ¶æ€æŠ¥å‘Š
  build-summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [build-web, build-macos]
    if: always()
    steps:
    - name: ðŸ“Š Generate Build Summary
      run: |
        echo "## ðŸŽ PomodoroGenie Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: ${{ github.event.inputs.build_type || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŽ¯ Build Results" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.build-web.result }}" = "success" ]; then
          echo "âœ… **Flutter Web App**: Built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Flutter Web App**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build-macos.result }}" = "success" ]; then
          echo "âœ… **macOS App**: Built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **macOS App**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **Web App**: Available in Actions artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **macOS App**: Available in Actions artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Download artifacts from Actions tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Deploy web app using provided scripts" >> $GITHUB_STEP_SUMMARY
        echo "3. Install macOS app following INSTALL.md" >> $GITHUB_STEP_SUMMARY
        echo "4. Test functionality on target systems" >> $GITHUB_STEP_SUMMARY
